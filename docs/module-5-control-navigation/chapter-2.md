# Chapter 2: Walking Pattern Generation and ZMP Control

## Introduction

Generating stable and dynamic walking patterns is a fundamental challenge in humanoid robotics. This chapter delves into the principles of bipedal locomotion, focusing on generating natural walking patterns and employing Zero Moment Point (ZMP) control for balance. The examples and concepts discussed will be illustrated with a focus on ROS 2 integration.

## Fundamentals of Bipedal Locomotion

Achieving stable walking on two legs requires sophisticated control strategies that manage the robot's center of mass (CoM) and ground reaction forces.

### Kinematic and Dynamic Models

-   **Kinematic Model**: Describes the relationship between joint angles and the robot's end-effector (foot) position and orientation.
-   **Dynamic Model**: Describes the forces and torques acting on the robot and how they influence motion, including inertia, gravity, and ground contact forces.

## Zero Moment Point (ZMP) Control

The Zero Moment Point (ZMP) is a key concept for maintaining dynamic balance in bipedal robots. It is the point on the ground where the moment generated by all forces acting on the robot (gravity, inertia) is zero.

### ZMP Theory and Application

-   **Definition**: ZMP is the point on the supporting surface where the net moment is zero.
-   **Balance Criterion**: For static and dynamic stability, the ZMP must remain within the robot's base of support (i.e., the area defined by the feet on the ground).
-   **CoM vs. ZMP**: While the Center of Mass (CoM) is the average location of mass, the ZMP is derived from the net moment. Controlling the CoM trajectory is a common method to influence and keep the ZMP within the base of support.
-   **Real-time Control**: Maintaining ZMP stability requires real-time feedback control, constantly adjusting joint torques and body posture based on sensor data.

## Walking Pattern Generation

Generating a stable and natural walking pattern involves planning the trajectory of the robot's feet, CoM, and torso over time.

### Trajectory Planning

-   **Foot Trajectories**: Planning the position and orientation of each foot during the gait cycle (swing and stance phases).
-   **CoM Trajectories**: Planning the path of the robot's Center of Mass to ensure ZMP stability.
-   **Body Posture**: Coordinating torso and arm movements to aid balance and stability.

### ROS 2 Integration for Walking

ROS 2 provides the framework for implementing these concepts.
*   **Real-time Control**: Utilizing `ros_control` and real-time kernel patches for deterministic joint control.
*   **Simulation**: Gazebo or Ignition Gazebo for simulating robot dynamics and testing walking patterns.
*   **Launch Files**: Creating `.launch.py` files to orchestrate different ROS 2 nodes for control, perception, and motion.

**Conceptual ROS 2 Launch File Snippet (`biped_walking_launch.launch.py`):**
```python
# Conceptual ROS 2 launch file for bipedal walking simulation
from launch import LaunchDescription
from launch_ros.actions import Node
from launch.actions import IncludeLaunchDescription
from launch.launch_description_source import PythonLaunchDescriptionSource
import os
from ament_index_python.packages import get_package_share_directory

def generate_launch_description():
    # Load robot description (URDF/XACRO)
    robot_description = get_package_share_directory('my_robot_description')
    robot_model_file = os.path.join(robot_description, 'urdf', 'my_biped.urdf')

    # Start Gazebo simulation
    gazebo_launch = IncludeLaunchDescription(
        PythonLaunchDescriptionSource([os.path.join(get_package_share_directory('gazebo_ros'), 'launch'), '/gazebo.launch.py']),
        launch_arguments={'world': 'walking_world.world'}.items()
    )

    # Spawn robot model in Gazebo
    spawn_robot = Node(package='gazebo_ros', executable='spawn_entity.py',
                      arguments=['-entity', 'biped_robot', '-file', robot_model_file],
                      output='screen')

    # Load controller manager for real-time control
    # This would involve loading controllers for joint state publishing and command execution
    controller_manager_node = Node(
        package='controller_manager',
        executable='ros2_control_node',
        parameters=[{'robot_description': robot_model_file},
                    os.path.join(get_package_share_directory('my_robot_controllers'), 'config', 'biped_controllers.yaml')]
    )

    # Node for walking pattern generation and ZMP control
    walking_controller_node = Node(
        package='my_robot_control',
        executable='walking_pattern_generator',
        name='walking_controller',
        parameters=[{'zmp_control_enabled': True}] # Example parameter
    )

    return LaunchDescription([
        gazebo_launch,
        spawn_robot,
        controller_manager_node,
        walking_controller_node
    ])
```

## Conclusion

Developing stable walking patterns and implementing ZMP control are critical steps toward creating autonomous humanoid robots. This chapter provides the theoretical background and practical considerations, emphasizing the role of ROS 2 in achieving these goals.
